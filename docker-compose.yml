version: '3.8'

services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: ecommerce-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: ecommerce_db
      MYSQL_USER: ecommerce_user
      MYSQL_PASSWORD: ecommerce_password
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpassword"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ecommerce-network

  # Catalog Service
  catalog-service:
    build:
      context: ./catalog-service
      dockerfile: Dockerfile
    container_name: ecommerce-catalog
    restart: unless-stopped
    ports:
      - "8001:80"
    environment:
      APP_ENV: production
      APP_DEBUG: false
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ecommerce_db
      DB_USERNAME: ecommerce_user
      DB_PASSWORD: ecommerce_password
    volumes:
      - ./catalog-service:/var/www/html
      - catalog_storage:/var/www/html/storage
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/products"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Checkout Service
  checkout-service:
    build:
      context: ./checkout-service
      dockerfile: Dockerfile
    container_name: ecommerce-checkout
    restart: unless-stopped
    ports:
      - "8002:80"
    environment:
      APP_ENV: production
      APP_DEBUG: false
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ecommerce_db
      DB_USERNAME: ecommerce_user
      DB_PASSWORD: ecommerce_password
      CATALOG_SERVICE_URL: http://catalog-service
      EMAIL_SERVICE_URL: http://email-service
    volumes:
      - ./checkout-service:/var/www/html
      - checkout_storage:/var/www/html/storage
    depends_on:
      mysql:
        condition: service_healthy
      catalog-service:
        condition: service_healthy
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Email Service
  email-service:
    build:
      context: ./email-service
      dockerfile: Dockerfile
    container_name: ecommerce-email
    restart: unless-stopped
    ports:
      - "8003:80"
    environment:
      APP_ENV: production
      APP_DEBUG: false
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ecommerce_db
      DB_USERNAME: ecommerce_user
      DB_PASSWORD: ecommerce_password
      MAIL_MAILER: log
    volumes:
      - ./email-service:/var/www/html
      - email_storage:/var/www/html/storage
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_CATALOG_SERVICE_URL: http://localhost:8001
        VITE_CHECKOUT_SERVICE_URL: http://localhost:8002
    container_name: ecommerce-frontend
    restart: unless-stopped
    ports:
      - "5173:80"
    depends_on:
      - catalog-service
      - checkout-service
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  ecommerce-network:
    driver: bridge

volumes:
  mysql_data:
  catalog_storage:
  checkout_storage:
  email_storage:

